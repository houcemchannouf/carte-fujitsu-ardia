> # Commented CAN driver Datasheet #

# Introduction #

> A CAN system sends messages using a serial bus network.With every node connected to every other node in the network,the need for a central controller for the entire network is made
> redundant. CAN being a multi-master communication protocol; every node in the system is equal to every other node. Any processor can send a message to any other processor. Evenif
> some processor fails, the other systems in the machine will continue to work properly and communicate with each other. Any node on the network that wants to transmit a message waits
> until the bus is free. Every message has an identifier, and every message is available to every other node in the network. The node selects those messages that are relevant and ignores
> the rest. The protocol never interrupts an ongoing transmission, but it assigns priorities to messages to prevent conflicts and to make sure that urgent messages are delivered first.The CAN
> protocol includes robust error detection and fault confinement mechanisms to make the traffic highly reliable. The robustness of the network is further augmented by the fact that any faulty
> node can be removed from the network without affecting the rest of the network. In CAN protocol, a non destructive bitwise arbitration method is utilized. This means that messages
> remain intact after arbitration is completed even if collisions are detected. All of this arbitration takes place without corruption or delay of the higher priority message. There are
> a couple of things that are required to support non-destructive bitwise arbitration. First, logic states need to be defined as dominant or recessive. Second, the transmitting node must
> monitor the state of the bus to see if the logic state it is trying to send actually appears on the bus. CAN defines a logic bit 0 as a dominant bit and a logic bit 1 as a recessive bit.

**CAN Message Frame Description**

> CAN protocol defines four different types of messages (or Frames). The first and most common type of frame is a _Data Frame_. This is used when a node transmits information to any or all
> other nodes in the system. Second is a _Remote Frame_, which is basically a Data Frame with the RTR bit set to signify it is a Remote Transmit Request (see Figure 2 and Figure 3 for
> details on Data Frames). The other two frame types are for handling errors. One is called an _Error Frame_ and one is called an _Overload Frame_. Error Frames are generated by
> nodes that detect any one of the many protocol errors defined by CAN. Overload errors are generated by nodes that require more time to process messages already received.


# Functions and registres definition #


## Function number one ##

**Initialisation du CAN0**

Fonction void CAN0\_init (unsigned long ulBaudRate, unsigned char ucFlag\_CAN)

> This function initialize the CAN interface. In fact, it should contain:

  1. The activation of the I/O CAN interface
  1. The activation of the Interruption model
  1. The configuration of transmission speed
  1. The start of the CAN operation

**Searching for I/O Port related to CAN interface in MB96340\_DS\_rev10\_20100623.pdf and check them in MB96340.h file**

**_Activation of the I/O CAN interface_**

|**PDR10**       | 00000AH I/O Port P10 - Port Data Register|
|:---------------|:-----------------------------------------|
|**PIER10**      | 00044EH I/O Port P10 - Port Input Enable Register|
|**COER0**       | 0007CEH CAN0 - Output enable register    |
|**COER0\_OE**    | LSB of COER0\_OE                         |
|**PIER10\_IE0**  | LSB of PIER10                            |
|**CTRLR0**      | 000700H CAN0 - Control register Low      |
|                | 000701H CAN0 - Control register High     |


|**CTRLR0\_IE**   | 2nd bit of CTRLR0 (1:Enable/0:disable interrupt module)|
|:----------------|:-------------------------------------------------------|
**_Activation of the Interruption model_**


|**CTRLR0\_CCE**  | 7th bit of CTRLR0 (1:Enable/0:disable Configuration Change)|
|:----------------|:-----------------------------------------------------------|
|**BTR0**         | 000706H CAN0 - Bit Timing Register Low BTRL0 (configure transmission speed)|
|                 | 000707H CAN0 - Bit Timing Register High BTRH0              |
**_Configuration of transmission speed_**

|**CTRLR0\_INIT** | LSB of CTRLR0 (1:Stop/0:Start CAN Operation)|
|:----------------|:--------------------------------------------|
**_Start of the CAN operation_**

## Function number two ##

**Tester l’initialisation de l’interface CAN0**

Fonction void vCAN0\_eInitSendTest\_Exe (void)

This function tests the initilization of CAN interface.In fact it contains the same details like the first one :

  1. The activation of the I/O CAN interface
  1. The activation of the Interruption model
  1. The configuration of transmission speed
  1. The start of the CAN operation

## Function number three ##

**Set RxBuffer**

Fonction void CAN0\_SetRxBuffer(unsigned char buffer, unsigned long id, unsigned char irq, unsigned long mask)

This function permit to transfer the recieved message at the registre interface in order to copy it in memory.In fact it should contain:

  1. Preparation of the arbitration registre interface
  1. Configuration of Mask registre interface
  1. Coping message to the register interface
  1. Coping message to the buffer

**Searching for I/O Port related to CAN interface in MB96340\_DS\_rev10\_20100623.pdf and check them in MB96340.h file**

**_Preparation of the arbitration registre interface_**
|IF1ARB0 | IF1ARB10|000718H CAN0 - IF1 Arbitration 1 Register Low IF1ARB1L0 |define message id (Use MSG2STD() for 11bit IDs/ Use MSG2EXT() for 29bit IDs)|
|:-------|:--------|:-------------------------------------------------------|:---------------------------------------------------------------------------|
|        |         |000719H CAN0 - IF1 Arbitration 1 Register High IF1ARB1H0|
|        | IF1ARB20|00071AH CAN0 - IF1 Arbitration 2 Register Low IF1ARB2L0 |
|        |         |00071BH CAN0 - IF1 Arbitration 2 Register High IF1ARB2H0|
|IF1ARB0\_XTD|the 31st bit of IF1ARB0 (Extended Identifier)|0: 11bit ID / 1: 29bit ID                               |
|IF1ARB0\_DIR|the 30th bit of IF1ARB0(Message Direction)|0: RX Buffer / 1: TX Buffer                             |
|IF1ARB0\_MSGVAL|the 32nd bit of IF1ARB0(Message Valid)| 0: Buffer invalid / 1: Buffer valid                    |


|IF1MSK0| IF1MSK10 | 000714H CAN0 - IF1 Mask 1 Register Low IF1MSK1L0  |Setup Mask corresponding to our application|
|:------|:---------|:--------------------------------------------------|:------------------------------------------|
|       |          | 000715H CAN0 - IF1 Mask 1 Register High IF1MSK1H0 |
|       | IF1MSK20 | 000716H CAN0 - IF1 Mask 2 Register Low IF1MSK2L0  |
|       |          | 000717H CAN0 - IF1 Mask 2 Register High IF1MSK2H0 |
|IF1MSK20\_MXTD|the 32nd bit of IF1MSK0(Mask Extended Identifier)|0: The extended identifier bit (XTD) has no effect on the acceptance filtering / 1: .. is used for filtering|
**_Configuration of Mask registre interface_**


|IF1MCTR0|00071CH CAN0 - IF1 Message Control Register Low IF1MCTRL0 |contain status information and control bits|
|:-------|:---------------------------------------------------------|:------------------------------------------|
|        |00071DH CAN0 - IF1 Message Control Register High IF1MCTRH0|
|IF1MCTR0\_NEWDAT|MSB of IF1MCTR0                                           |0:Clear NEWDAT Flag /1:indicate that new data (not yet seen by the CPU) has been received|
|IF1MCTR0\_MSGLST|14th bit of IF1MCTR0                                      |0:Clear MSGLST Flag /1:indicate that the previous data (supposedly not seen by the CPU) is lost|
|IF1MCTR0\_INTPND|13th bit of IF1MCTR0                                      |0:Clear INTPND Flag /1:point to this Message Object by the Interrupt Register|
|IF1MCTR0\_UMASK |12th bit of IF1MCTR0(Use Acceptance Mask)                 |0: Not use Filter mask (Full CAN Object) / 1: Use Mask (MSK28-0, MXTD, and MDIR) for acceptance filtering|
|IF1MCTR0\_TXIE|11th bit of IF1MCTR0                                      |0: Disable Tx-Interrupt(INTPND will be left unchanged after the successful transmission of a frame) / 1: Enable Tx-Interrupt(INTPND will be set...)|
|IF1MCTR0\_RXIE|10th bit of IF1MCTR0                                      |0: Disable Rx-Interrupt(INTPND will be left unchanged after a successful reception of a frame.) / 1: Enable Rx-Interrupt(INTPND will be set...)|
|IF1MCTR0\_RMTEN|9th bit of IF1MCTR0(Remote Enable)                        |0:Disable Remote(At the reception of a Remote Frame, TXRQST is left unchanged) / 1: enable Remote(...TXRQST is set)|
|IF1MCTR0\_TXRQST|8th bit of IF1MCTR0                                       |0:Clear Transmission Request/1: Message Object transmission is requested and is not yet done.|
|IF1MCTR0\_EOB|8th bit of IF1MCTR0(End of Buffer)                        |0: Buffer is part of FiFo / 1: Single message buffer|
**_Coping message to the register interface_**

|IF1CREQ0|000710H CAN0 - IF1 Command request register Low IF1CREQL0|specify the message number and transfet the Message Object in the buffer|
|:-------|:--------------------------------------------------------|:-----------------------------------------------------------------------|
|        |000711H CAN0 - IF1 Command request register High IF1CREQH0|
**_Coping message to the buffer_**